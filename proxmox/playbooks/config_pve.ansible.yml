---

# Description
- name: Pve auto configuration
  hosts: pve
  gather_facts: true
  vars_files: 
    - ../vars/pve.yml  
  tasks:
    - name: Delete enterprise repository
      ansible.builtin.file:
        state: absent
        path: /etc/apt/sources.list.d/pve-enterprise.list

    - name: Disable enterprise repository in ceph
      lineinfile:
        path: /etc/apt/sources.list.d/ceph.list
        # The String to Search
        regexp: "^deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise" 
        # The String to Replace
        line: "# deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise"
        state: present

    - name: Enable no-subscription repository
      lineinfile:
        path: /etc/apt/sources.list
        line: "deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription"
        state: present

    - name: Update and upgrade apt packages
      become: yes
      ansible.builtin.apt:
        update_cache: no
        cache_valid_time: 86400 #One day

#    - name: Install the latest version of wireless-tools
#      ansible.builtin.package:
#        name:
#          - wireless-tools
#        state: latest

#    - name: Install the latest version of python3-proxmoxer
#      ansible.builtin.package:
#        name:
#          - python3-proxmoxer
#        state: latest

    - name: Upgrade the OS (apt-get dist-upgrade)
      ansible.builtin.apt:
        upgrade: dist
      
    - name: map nas storage
      blockinfile:
        dest: /etc/pve/storage.cfg
        block: |

          nfs: nas-iso
            export {{ nas_path }}
            path /mnt/pve/nas-iso
            server {{ nas_ip }}
            content iso
            prune-backups keep-all=1

          nfs: nas-backup
            export {{ nas_path }}
            path /mnt/pve/nas-backup
            server {{ nas_ip }}
            content backup
            prune-backups keep-all=1

#    - name: delete role
      # Comment
#      become: yes
#      ansible.builtin.shell:
#        cmd: pveum role delete AnsibleProv

#    - name: delete user
      # Comment
#      become: yes
#      ansible.builtin.shell:
#        cmd: pveum user delete ansible-prov@pve

#    - name: Create role
      # Comment
#      become: yes
#      ansible.builtin.shell:
#        cmd: pveum role add AnsibleProv -privs "Datastore.Allocate Datastore.AllocateSpace Datastore.Audit Pool.Allocate Sys.Audit Sys.Console Sys.Modify VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.Cloudinit VM.Config.CPU VM.Config.Disk VM.Config.HWType VM.Config.Memory VM.Config.Network VM.Config.Options VM.Console VM.Migrate VM.Monitor VM.PowerMgmt SDN.Use"

#    - name: Create user
      # Comment
#      become: yes
#      ansible.builtin.shell:
#        cmd: pveum user add ansible-prov@pve --password @ns1bl3 --comment "Ansible Provisioning"

#    - name: Assign group to user
      # Comment
#      become: yes
#      ansible.builtin.shell:
#        cmd: pveum aclmod / -user ansible-prov@pve -role AnsibleProv

#    - name: Create token
      # Comment
#      become: yes
#      ansible.builtin.shell:
#        cmd: pveum user token add ansible-prov@pve ansible -expire 0 -privsep 0 -comment "ansible token"
#      register: token
    
#    - name: Show token      # Comment
#      ansible.builtin.debug:
#        msg: "{{ token.stdout_lines }}"
    